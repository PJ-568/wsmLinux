<!DOCTYPE html>
<html lang="cn" style="height:100%;">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=1100, initial-scale=1.0">
    <title>PJ568 后端服务器终端</title>

    <meta name="description" content="PJ568 后端服务器访问页面。">
    <meta name="keywords" content="SSH, Linux, WebAssembly">
    <meta property="og:title" content="PJ568 后端服务器终端" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="PJ568 服务器" />

    <!-- Apple iOS web clip compatibility tags -->
    <meta name="application-name" content="PJ568 服务器" />
    <meta name="apple-mobile-web-app-title" content="PJ568 服务器" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <link rel="shortcut icon" href="icon.svg">
    <link rel="stylesheet" href="xterm/xterm.css" />
    <link rel="stylesheet" href="scrollbar.css" />
    <script src="serviceWorker.js"></script>
    <script src="xterm/xterm.js"></script>
    <script src="xterm/xterm-addon-fit.js"></script>
    <script src="network.js"></script>
    <script defer src="https://plausible.leaningtech.com/js/script.js"></script>
</head>

<body style="margin:0;height:100%;background:black;color:#E0E0E0;overflow:hidden;display:flex;flex-direction:column; justify-content:space-between;height:100%;">
    <div>
        <div style="padding-top: 0.7rem;padding-bottom: 0.7rem;font-size: 0.3rem; font-weight: 200;vertical-align:center;height: 5rem;">
            <div style="margin-left: 20px; height: 100%; display: flex; align-items: center; justify-content: space-between;">
                <pre style="font-weight: 600; font-size: large; color: #ad7fa8;">
__      __   _  __   ____  __
\ \    / /__| |_\ \ / /  \/  |
 \ \/\/ / -_) '_ \ V /| |\/| |
  \_/\_/\___|_.__/\_/ |_|  |_|
                </pre>
                <div style="height:100%;display: flex; flex-direction: column;justify-content: space-between;">
                    <div style="padding-top: 0.7rem;font-size: 0.3rem; font-weight: 200;vertical-align:center;height:50px;">
                        <div style="margin-right: 10px; margin-left: 20px; height: 100%; display: flex; align-items: center; justify-content: flex-end;gap: 50px;">
                            <div style="color: #E0E0E0; font-family: montserrat; font-weight: 400; font-size: large; height: 100%; display: flex; align-items: center;">
                                <span>处理器：</span>
                                <span id="cpuactivity" style="margin-left: 7px;">空载</span>
                            </div>
                            <div style="color: #E0E0E0; font-family: montserrat; font-weight: 400; font-size: large; height: 100%; display: flex; align-items: center;">
                                <span>存储：</span>
                                <span id="hddactivity" style="margin-left: 7px;">空载</span>
                            </div>
                            <a id="loginLink" style="user-select: text ;text-decoration: none; height: 100%;">
                                <div style="color: #E0E0E0; font-family: montserrat; font-weight: 400; font-size: large; height: 100%; display: flex; align-items: center;">
                                    <div style="position: relative;">
                                        <span style="cursor: pointer" id="networkStatus">连接到服务器</span>
                                        <span style="cursor: pointer; position: absolute; right: 0px; visibility: hidden;" id="ipCopied">已复制。</span>
                                    </div>
                                    <!-- <img src="assets/tailscale.svg" height="35px" style="margin-left: 7px;"> -->
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="flex-grow:0; flex-shrink: 0; height:1px; width: 100%; background-color: #E0E0E0;">
    </div>
    <main style="display: flex; flex-direction: row; justify-content: space-between; margin: 5px; height: 100%;">
        <div style="flex-grow:1; height:100%;display:inline-block;margin:0;" class="scrollbar" id="console">
        </div>
    </main>
    <script>

        //Utility namespace to group all functionality related to printing (both error and non error) messages
        const color = "\x1b[1;35m";
        const bold = "\x1b[1;37m";
        const underline = "\x1b[94;4m";
        const normal = "\x1b[0m";
        var printOnTerm = {
            getAsciiTitle: function () {
                var title = [
                    color + "+------------------------------------------+" + normal,
                    color + "|                                          |" + normal,
                    color + "|           PJ568 后端服务器终端           |" + normal,
                    color + "|                                          |" + normal,
                    color + "+------------------------------------------+" + normal,

                ];
                return title;
            },
            getAsciiText: function () {
                var text = [
                    "+------------------------------------------+",
                    "|                                          |",
                    "|           PJ568 后端服务器终端           |",
                    "|                                          |",
                    "+------------------------------------------+",
                    "",
                    "运行以下指令以查看部分可执行指令：",
                    "",
                    "  cat /home/pj568/runable.md",
                    "",
                ];
                return text;
            },
            getSharedArrayBufferMissingMessage: function () {
                const isCustom = window.location.hostname !== "dsh.pj568.eu.oeg";
                const isSecureContext = window.isSecureContext;
                const text = [
                    "",
                    "",
                    color + "CheerpX 启动失败" + normal,
                    "",
                    "CheerpX 依赖 SharedArrayBuffer 功能，但当前无法正常使用。",
                    "",
                    !isSecureContext && "  -  This page is not in a secure context. Serve over HTTPS or WSS.",
                    !isSecureContext && "    " + underline + "https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts" + noral,
                    isCustom && "  -  The document is not cross-origin isolated.",
                    isCustom && "     " + underline + "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements" + normal,
                    "  - 您的浏览器可能不支持 SharedArrayBuffer 功能。",
                    "    自 2022 以来，主流浏览器皆支持此功能。",
                    "    " + underline + "https://caniuse.com/sharedarraybuffer" + normal,
                ].filter(Boolean);

                return text;
            },
            getErrorMessage: function (error_message) {
                const text = [
                    "",
                    "",
                    color + "CheerpX 启动失败" + normal,
                    "",
                    "错误代码：",
                    error_message,
                    "",
                    "",
                    "已知 CheerpX 支持 Chrome 、Edge 、Firefox 和 Safari 。",
                    "",
                    "",
                    "请确保您使用桌面平台或尝试更换浏览器再试。",
                ]

                return text;
            },
            printMessage: function (text) {
                for (var i = 0; i < text.length; i++) {
                    term.write(text[i]);
                    term.write('\n');
                }
            },
            printError: function (message) {
                this.printMessage(message);

                term.write("\n\n");

                function writeCustom(something) {
                    term.write(something);
                }
            },
        };

        var consoleDiv = document.getElementById("console");

        //xterm.js related logic
        var term = new Terminal({ cursorBlink: true, convertEol: true, fontWeight: 400, fontWeightBold: 700 });
        var fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(consoleDiv);
        term.scrollToTop();

        fitAddon.fit();
        window.addEventListener("resize", function (ev) { fitAddon.fit(); }, false);
        term.focus();
        var cxReadFunc = null;
        function writeData(buf) {
            term.write(new Uint8Array(buf));
        }
        function readData(str) {
            if (cxReadFunc == null)
                return;
            for (var i = 0; i < str.length; i++)
                cxReadFunc(str.charCodeAt(i));
        }
        term.onData(readData);

        //Actual CheerpX and bash specific logic
        function runBash() {
            // cmd, cwd, args and env are replaced by the Github actions workflow.
            var cmd = CMD;
            var args = ARGS;
            var env = ENV;
            var cwd = CWD;
            // Reasonable defaults for local deployments
            // var cmd = "/bin/bash";
            // var args = ["--login"];
            // var env = ["HOME=/home/pj568", "TERM=xterm", "USER=pj568", "SHELL=/bin/bash", "EDITOR=nano", "LANG=zh_CN.UTF-8", "LC_ALL=C"];
            // var cwd = "/home/pj568";
            const structure = {
                cmd: cmd,
                args: args,
                env: env,
                cwd: cwd
            }
            if (typeof SharedArrayBuffer === "undefined") {
                printOnTerm.printError(printOnTerm.getSharedArrayBufferMissingMessage());
                return;
            }

            let networkInterface = setupNetworkInterface();

            async function runTest(cx) {
                registerNetworkLogin(cx, networkInterface);

                term.scrollToBottom();

                async function cxLogAndRun(cheerpx, cmd, args, env) {
                    await cheerpx.run(cmd, args, env);
                    printOnTerm.printMessage(" ");
                }

                cxReadFunc = cx.setCustomConsole(writeData, term.cols, term.rows);

                function preventDefaults(e) {
                    e.preventDefault()
                    e.stopPropagation()
                }
                consoleDiv.addEventListener("dragover", preventDefaults, false);
                consoleDiv.addEventListener("dragenter", preventDefaults, false);
                consoleDiv.addEventListener("dragleave", preventDefaults, false);
                consoleDiv.addEventListener("drop", preventDefaults, false);

                var opts = { env: structure.env, cwd: structure.cwd, uid: 1000, gid: 1000 };
                while (true) {
                    await cxLogAndRun(cx, structure.cmd, structure.args, opts);
                }
            }
            function failCallback(err) {
                printOnTerm.printError(printOnTerm.getErrorMessage(err));
            }
            function devCallback(state) {
                var h = document.getElementById("hddactivity");
                if (state == "ready")
                    h.textContent = "负载";
                else
                    h.textContent = "空载";
            }
            function cpuCallback(state) {
                var h = document.getElementById("cpuactivity");
                if (state == "ready")
                    h.textContent = "负载";
                else
                    h.textContent = "空载";
            }
            // The device url and type are replaced by Github Actions.
            CheerpXApp.create({ devices: [{ type: DEVICE_TYPE, url: IMAGE_URL, name: "block1" }], mounts: [{ type: "ext2", dev: "block1", path: "/" }, { type: "cheerpOS", dev: "/app", path: "/app" }, { type: "cheerpOS", dev: "/str", path: "/data" }, { type: "devs", dev: "", path: "/dev" }], networkInterface: networkInterface, activityInterface: { cpu: cpuCallback, dev: devCallback } }).then(runTest, failCallback);
        }
        function initialMessage() {
            printOnTerm.printMessage(printOnTerm.getAsciiText());
            term.registerLinkMatcher(/https:\/\/leaningtech.com\/[a-z-]+/, function (mouseEvent, matchedString) {
                window.open(matchedString, "_blank")
            });
            console.log("请注意：一旦启动开发工具后很可能会造成卡顿或崩溃。");
        }
        initialMessage();
        async function loadCX() {
            // Find the latest build
            var r = await fetch("https://cheerpxdemos.leaningtech.com/publicdeploy/LATEST.txt");
            var url = await r.text();
            url = url.trim();
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;
            script.addEventListener("load", runBash, false);
            document.head.appendChild(script);
        }
        loadCX();
    </script>
</body>

</html>